# DeviceCard Component

Модульная структура компонента для отображения и управления IoT устройствами.

## Структура компонентов

```
DeviceCard/
├── DeviceCard.jsx          # Главный компонент карточки устройства
├── IrrigatorCard.jsx       # Карточка ирригатора с поддержкой 4 режимов
├── LightTimerCard.jsx      # Карточка таймера освещения
├── IrrigationTimeline.jsx  # Визуализация карты полива на временной шкале
├── IrrigationMapDialog.jsx # Диалог редактирования карты полива
├── Status.jsx              # Индикатор статуса подключения
├── Outputs.jsx             # Отображение выходов устройства
├── TimerMode.jsx           # Переключатель режимов работы
├── TimeField.jsx           # Поле ввода времени
├── EnableField.jsx         # Поле включения/выключения с подтверждением
├── utils.js                # Утилиты для работы со временем
└── index.js                # Экспорт всех компонентов
```

## Основные компоненты

### DeviceCard
Главный компонент, отображающий информацию об устройстве.

**Props:**
- `device` - объект устройства с полями: `id`, `address`, `config`, `status`

### IrrigatorCard
Компонент управления ирригатором с поддержкой 4 режимов работы:
- **0 - Off**: Выключен
- **1 - Manual**: Ручной режим
- **2 - Auto**: Автоматический режим (по времени + количество поливов)
- **3 - Map**: Режим по карте (временные периоды полива)

**Props:**
- `name` - имя ирригатора (например, "irr1")
- `config` - конфигурация ирригатора
- `onSave` - коллбэк сохранения настроек
- `deviceId` - ID устройства

**Режим Map (новый функционал):**
- Позволяет создавать карту полива с несколькими временными периодами
- Поддерживает RPC методы `Get.IrrigationTable` и `Set.IrrigationTable`
- Визуализирует периоды на 24-часовой шкале
- Предотвращает пересечение периодов

### IrrigationTimeline
Визуальный компонент для отображения карты полива на суточной временной шкале.

**Props:**
- `regMap` - массив периодов полива `[{start: number, stop: number}]` или JSON строка

**Особенности:**
- Отображает периоды на 24-часовой шкале
- Показывает время начала и конца каждого периода
- Выводит список периодов с продолжительностью

### IrrigationMapDialog
Диалоговое окно для создания и редактирования карты полива.

**Props:**
- `open` - состояние открытия диалога
- `onClose` - коллбэк закрытия
- `onSave` - коллбэк сохранения (получает массив периодов)
- `initialMap` - начальная карта полива
- `deviceId` - ID устройства
- `irrigatorName` - название ирригатора

**Функционал:**
- Добавление временных периодов полива
- Удаление периодов
- Проверка на пересечение периодов
- Визуализация карты в реальном времени
- Автоматическая сортировка периодов по времени начала

### LightTimerCard
Компонент управления таймером освещения.

**Props:**
- `name` - имя таймера
- `config` - конфигурация таймера
- `onSave` - коллбэк сохранения

## Вспомогательные компоненты

### Status
Индикатор статуса подключения устройства.

### Outputs
Отображение состояния выходов устройства.

### TimerMode
Переключатель режимов работы (Off/Manual/Auto/Map).

### TimeField
Поле ввода времени с поддержкой dayjs.

### EnableField
Чекбокс с подтверждением через Popover.

## Утилиты (utils.js)

### secToTime(seconds)
Конвертирует секунды в объект dayjs.

**Параметры:**
- `seconds` - время в секундах

**Возвращает:** dayjs объект

### timeToSec(time)
Конвертирует dayjs объект в секунды.

**Параметры:**
- `time` - dayjs объект

**Возвращает:** число секунд

### TIMER_MODES
Константа с названиями режимов: `["Off", "Manual", "Auto", "Map"]`

## API интеграция (deviceApi.js)

### Новые эндпоинты:

#### useGetIrrigationTableQuery
Получение карты полива с устройства.

**Параметры:**
- `deviceId` - ID устройства
- `irrigator` - имя ирригатора

**RPC метод:** `Get.IrrigationTable`

#### useSetIrrigationTableMutation
Отправка карты полива на устройство.

**Параметры:**
- `deviceId` - ID устройства
- `irrigator` - имя ирригатора
- `regMap` - массив периодов полива

**RPC метод:** `Set.IrrigationTable`

**Формат данных:**
```javascript
{
  "irrigator": "Irrigator1",
  "reg_map": "[{\"start\":0,\"stop\":100},{\"start\":200,\"stop\":300}]"
}
```

## Использование

```jsx
import DeviceCard from './components/DeviceCard';

<DeviceCard device={deviceData} />
```

## Особенности реализации

1. **Модульность**: Каждый компонент вынесен в отдельный файл для лучшей поддерживаемости
2. **Типизация**: Все компоненты используют PropTypes для валидации пропсов
3. **RPC интеграция**: Использование RTK Query для взаимодействия с устройствами
4. **UX**: Диалоги с подтверждением для важных действий
5. **Визуализация**: Наглядное отображение временных периодов на шкале
6. **Валидация**: Проверка на пересечение периодов и корректность времени

## TODO / Будущие улучшения

- [ ] Добавить drag & drop для изменения периодов на временной шкале
- [ ] Реализовать импорт/экспорт карт полива
- [ ] Добавить шаблоны карт полива
- [ ] Улучшить визуализацию для мобильных устройств
- [ ] Добавить историю изменений карт полива
